{% extends "base.html" %}
{% block title %}Alpha Bot - P/L Analyzer{% endblock %}
{% block content %}
<h2>Telegram Group P/L Analyzer</h2>

{% if not configured %}
<div class="section-card" style="border-color: #d29922;">
    <h3 style="color: #d29922;">Setup Required</h3>
    <p style="margin: 0.5rem 0;">To analyze a Telegram group's ticker calls, you need:</p>
    <ol style="margin: 0.8rem 0 0.8rem 1.5rem; font-size: 0.9rem; line-height: 2;">
        <li>Go to <a href="https://my.telegram.org/apps" target="_blank" style="color: #58a6ff;">my.telegram.org/apps</a> and create an app to get your <strong>API ID</strong> and <strong>API Hash</strong></li>
        <li>Enter them in <a href="/settings" style="color: #58a6ff;">Settings</a> under "Telegram Group Monitoring"</li>
        <li>Run the setup script once to authenticate:
            <code style="display: block; background: #0d1117; padding: 0.5rem 0.8rem; border-radius: 6px; margin-top: 0.3rem; font-size: 0.85rem;">
                python setup_telethon.py
            </code>
        </li>
    </ol>
</div>

{% elif not session_exists %}
<div class="section-card" style="border-color: #d29922;">
    <h3 style="color: #d29922;">Authentication Needed</h3>
    <p style="margin: 0.5rem 0;">Telegram API credentials are configured, but you need to authenticate once. Run:</p>
    <code style="display: block; background: #0d1117; padding: 0.5rem 0.8rem; border-radius: 6px; margin-top: 0.5rem; font-size: 0.85rem;">
        python setup_telethon.py
    </code>
    <p style="margin-top: 0.5rem; font-size: 0.85rem; color: #8b949e;">
        This will ask for your phone number and a verification code from Telegram. You only need to do this once.
    </p>
</div>

{% else %}

{# --- Analysis Form --- #}
<form method="post" action="/pnl" class="research-form" id="pnl-form">
    <input type="text" name="group" placeholder="Group username or ID"
           value="{{ group_name or s.telegram_monitor_group }}" style="width: 250px;">
    <input type="number" name="days" placeholder="Days" value="{{ days or 90 }}"
           min="7" max="365" style="width: 100px;">
    <button type="submit" id="analyze-btn">Analyze P/L</button>
</form>
<p style="font-size: 0.8rem; color: #8b949e; margin-top: -0.8rem; margin-bottom: 1rem;">
    This may take a few minutes — scraping messages + fetching prices from CoinGecko.
</p>

{% if error is defined and error %}
<div class="section-card" style="border-color: #f85149;">
    <p style="color: #f85149;">{{ error }}</p>
</div>
{% endif %}

{% if report %}

    {# --- Summary Cards --- #}
    <div class="section-card">
        <h3>Performance Summary</h3>
        <div class="stats-grid">
            <div class="stat-box">
                <div class="value">{{ report.total_calls }}</div>
                <div class="label">Ticker Calls</div>
            </div>
            <div class="stat-box">
                <div class="value">{{ report.unique_tickers }}</div>
                <div class="label">Unique Tickers</div>
            </div>
            <div class="stat-box">
                <div class="value">{{ report.resolved_tickers }}</div>
                <div class="label">Resolved (Priced)</div>
            </div>
            <div class="stat-box">
                <div class="value" style="color: {{ '#3fb950' if report.overall_win_rate >= 50 else '#f85149' }}">
                    {{ "%.1f"|format(report.overall_win_rate) }}%
                </div>
                <div class="label">Win Rate</div>
            </div>
            <div class="stat-box">
                <div class="value" style="color: {{ '#3fb950' if report.overall_avg_pnl >= 0 else '#f85149' }}">
                    {{ "%+.1f"|format(report.overall_avg_pnl) }}%
                </div>
                <div class="label">Avg P/L</div>
            </div>
            <div class="stat-box">
                <div class="value">{{ report.days_analyzed }}d</div>
                <div class="label">Period</div>
            </div>
        </div>

        {% if report.best_call %}
        <div style="display: flex; gap: 1rem; margin-top: 0.8rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px; background: #0d1117; border: 1px solid #238636; border-radius: 6px; padding: 0.6rem 0.8rem;">
                <div style="font-size: 0.75rem; color: #3fb950; text-transform: uppercase;">Best Call</div>
                <div style="font-weight: 700; color: #3fb950; font-size: 1.1rem;">
                    ${{ report.best_call.ticker }} {{ "%+.1f"|format(report.best_call.pnl_pct) }}%
                </div>
                <div style="font-size: 0.8rem; color: #8b949e;">
                    {{ report.best_call.posted_at.strftime('%b %d') }} &middot;
                    ${{ "%.4f"|format(report.best_call.entry_price) if report.best_call.entry_price < 1 else "{:,.2f}".format(report.best_call.entry_price) }}
                    → ${{ "%.4f"|format(report.best_call.current_price) if report.best_call.current_price < 1 else "{:,.2f}".format(report.best_call.current_price) }}
                </div>
            </div>
            {% if report.worst_call %}
            <div style="flex: 1; min-width: 200px; background: #0d1117; border: 1px solid #f85149; border-radius: 6px; padding: 0.6rem 0.8rem;">
                <div style="font-size: 0.75rem; color: #f85149; text-transform: uppercase;">Worst Call</div>
                <div style="font-weight: 700; color: #f85149; font-size: 1.1rem;">
                    ${{ report.worst_call.ticker }} {{ "%+.1f"|format(report.worst_call.pnl_pct) }}%
                </div>
                <div style="font-size: 0.8rem; color: #8b949e;">
                    {{ report.worst_call.posted_at.strftime('%b %d') }} &middot;
                    ${{ "%.4f"|format(report.worst_call.entry_price) if report.worst_call.entry_price < 1 else "{:,.2f}".format(report.worst_call.entry_price) }}
                    → ${{ "%.4f"|format(report.worst_call.current_price) if report.worst_call.current_price < 1 else "{:,.2f}".format(report.worst_call.current_price) }}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    {# --- Ticker Breakdown --- #}
    {% if report.ticker_summaries %}
    <div class="section-card">
        <h3>Ticker Breakdown</h3>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead>
                    <tr style="border-bottom: 1px solid #30363d; text-align: left;">
                        <th style="padding: 0.5rem 0.3rem; color: #8b949e; font-size: 0.8rem;">TICKER</th>
                        <th style="padding: 0.5rem 0.3rem; color: #8b949e; font-size: 0.8rem;">CALLS</th>
                        <th style="padding: 0.5rem 0.3rem; color: #8b949e; font-size: 0.8rem;">AVG ENTRY</th>
                        <th style="padding: 0.5rem 0.3rem; color: #8b949e; font-size: 0.8rem;">CURRENT</th>
                        <th style="padding: 0.5rem 0.3rem; color: #8b949e; font-size: 0.8rem;">AVG P/L</th>
                        <th style="padding: 0.5rem 0.3rem; color: #8b949e; font-size: 0.8rem;">BEST</th>
                        <th style="padding: 0.5rem 0.3rem; color: #8b949e; font-size: 0.8rem;">W/L</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in report.ticker_summaries %}
                    <tr style="border-bottom: 1px solid #21262d;">
                        <td style="padding: 0.5rem 0.3rem;">
                            <span class="ticker-tag">${{ s.ticker }}</span>
                        </td>
                        <td style="padding: 0.5rem 0.3rem;">{{ s.call_count }}</td>
                        <td style="padding: 0.5rem 0.3rem;">
                            {% if s.avg_entry_price %}
                                ${{ "%.4f"|format(s.avg_entry_price) if s.avg_entry_price < 1 else "{:,.2f}".format(s.avg_entry_price) }}
                            {% else %}—{% endif %}
                        </td>
                        <td style="padding: 0.5rem 0.3rem;">
                            {% if s.current_price %}
                                ${{ "%.4f"|format(s.current_price) if s.current_price < 1 else "{:,.2f}".format(s.current_price) }}
                            {% else %}—{% endif %}
                        </td>
                        <td style="padding: 0.5rem 0.3rem; font-weight: 600; color: {{ '#3fb950' if s.avg_pnl_pct and s.avg_pnl_pct >= 0 else '#f85149' }};">
                            {% if s.avg_pnl_pct is not none %}{{ "%+.1f"|format(s.avg_pnl_pct) }}%{% else %}—{% endif %}
                        </td>
                        <td style="padding: 0.5rem 0.3rem; color: {{ '#3fb950' if s.best_pnl_pct and s.best_pnl_pct >= 0 else '#f85149' }};">
                            {% if s.best_pnl_pct is not none %}{{ "%+.1f"|format(s.best_pnl_pct) }}%{% else %}—{% endif %}
                        </td>
                        <td style="padding: 0.5rem 0.3rem;">
                            <span style="color: #3fb950;">{{ s.win_count }}W</span>
                            /
                            <span style="color: #f85149;">{{ s.loss_count }}L</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {# --- All Calls --- #}
    {% if report.all_calls %}
    <div class="section-card">
        <h3>All Calls ({{ report.all_calls|length }})</h3>
        <div style="max-height: 500px; overflow-y: auto;">
            {% for c in report.all_calls %}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #21262d;">
                <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="ticker-tag">${{ c.ticker }}</span>
                        <span style="font-size: 0.8rem; color: #8b949e;">{{ c.posted_at.strftime('%b %d, %H:%M') }}</span>
                        {% if c.author %}
                        <span style="font-size: 0.8rem; color: #58a6ff;">@{{ c.author }}</span>
                        {% endif %}
                    </div>
                    <p style="font-size: 0.85rem; margin-top: 0.2rem; color: #8b949e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 500px;">
                        {{ c.message_text[:120] }}{% if c.message_text|length > 120 %}…{% endif %}
                    </p>
                </div>
                <div style="text-align: right; min-width: 120px; margin-left: 0.5rem;">
                    {% if c.pnl_pct is not none %}
                    <div style="font-weight: 700; font-size: 1rem; color: {{ '#3fb950' if c.pnl_pct >= 0 else '#f85149' }};">
                        {{ "%+.1f"|format(c.pnl_pct) }}%
                    </div>
                    <div style="font-size: 0.75rem; color: #8b949e;">
                        ${{ "%.4f"|format(c.entry_price) if c.entry_price < 1 else "{:,.2f}".format(c.entry_price) }}
                        → ${{ "%.4f"|format(c.current_price) if c.current_price < 1 else "{:,.2f}".format(c.current_price) }}
                    </div>
                    {% else %}
                    <div style="font-size: 0.85rem; color: #8b949e;">No price data</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

{% endif %}{# end report #}
{% endif %}{# end session_exists check #}

{# --- Past Analyses --- #}
{% if past_analyses is defined and past_analyses %}
<h2 style="margin-top: 2rem;">Past Analyses</h2>
{% for a in past_analyses %}
    {% set data = json.loads(a.report_json) %}
    <div class="section-card">
        <div class="signal-header">
            <div>
                <span style="font-weight: 700; color: #58a6ff;">{{ a.group_name }}</span>
                <span style="margin-left: 0.5rem; font-size: 0.85rem; color: #8b949e;">{{ a.days_analyzed }}d</span>
            </div>
            <span style="font-size: 0.8rem; color: #8b949e;">{{ a.created_at.strftime('%b %d, %H:%M') }}</span>
        </div>
        <div class="stats-grid" style="margin-top: 0.5rem;">
            <div class="stat-box">
                <div class="value">{{ a.total_calls }}</div>
                <div class="label">Calls</div>
            </div>
            <div class="stat-box">
                <div class="value">{{ a.resolved_tickers }}</div>
                <div class="label">Tickers</div>
            </div>
            <div class="stat-box">
                <div class="value" style="color: {{ '#3fb950' if a.win_rate >= 50 else '#f85149' }}">
                    {{ "%.1f"|format(a.win_rate) }}%
                </div>
                <div class="label">Win Rate</div>
            </div>
            <div class="stat-box">
                <div class="value" style="color: {{ '#3fb950' if a.avg_pnl >= 0 else '#f85149' }}">
                    {{ "%+.1f"|format(a.avg_pnl) }}%
                </div>
                <div class="label">Avg P/L</div>
            </div>
        </div>
    </div>
{% endfor %}
{% endif %}

<script>
document.getElementById('pnl-form')?.addEventListener('submit', function() {
    const btn = document.getElementById('analyze-btn');
    btn.textContent = 'Analyzing…';
    btn.disabled = true;
    btn.style.opacity = '0.6';
});
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}Scanner — Alpha Bot{% endblock %}
{% block content %}

<h2>Scanner — Narrative Radar</h2>

<div class="section-card">
    <h3>Trending Themes</h3>
    {% if themes %}
    <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
        <thead>
            <tr style="border-bottom:1px solid #30363d; color:#8b949e;">
                <th style="text-align:left; padding:0.4rem 0.6rem;">Theme</th>
                <th style="text-align:left; padding:0.4rem 0.6rem;">Source</th>
                <th style="text-align:right; padding:0.4rem 0.6rem;">Velocity</th>
                <th style="text-align:right; padding:0.4rem 0.6rem;">Volume</th>
                <th style="text-align:left; padding:0.4rem 0.6rem;">Category</th>
                <th style="text-align:left; padding:0.4rem 0.6rem;">Updated</th>
            </tr>
        </thead>
        <tbody>
            {% for t in themes %}
            <tr style="border-bottom:1px solid #21262d;">
                <td style="padding:0.4rem 0.6rem;">{{ t.theme[:60] }}</td>
                <td style="padding:0.4rem 0.6rem;">
                    <span class="badge" style="background:{% if t.source == 'google' %}#4285f4{% elif t.source == 'reddit' %}#ff4500{% elif t.source == 'farcaster' %}#8b5cf6{% else %}#238636{% endif %}">
                        {{ t.source }}
                    </span>
                </td>
                <td style="text-align:right; padding:0.4rem 0.6rem; color:{% if t.velocity > 0 %}#3fb950{% else %}#f85149{% endif %};">
                    {% if t.velocity > 0 %}+{% endif %}{{ "%.0f"|format(t.velocity) }}%
                </td>
                <td style="text-align:right; padding:0.4rem 0.6rem;">{{ t.current_volume }}</td>
                <td style="padding:0.4rem 0.6rem; color:#8b949e;">{{ t.category }}</td>
                <td style="padding:0.4rem 0.6rem; color:#8b949e; font-size:0.8rem;">
                    {{ t.last_updated.strftime('%m/%d %H:%M') if t.last_updated else '—' }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty">No trending themes yet. Enable the scanner with SCANNER_ENABLED=true.</p>
    {% endif %}
</div>

<div class="section-card" style="margin-top:1.5rem;">
    <h3>Scanner Candidates</h3>

    {% if candidates %}
    <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
        <a href="/scanner" class="badge" style="text-decoration:none; {% if not tier_filter %}background:#58a6ff{% endif %}">All ({{ candidates|length }})</a>
        <a href="/scanner?tier=1" class="badge" style="text-decoration:none; {% if tier_filter == '1' %}background:#f85149{% else %}background:#30363d{% endif %}">Tier 1</a>
        <a href="/scanner?tier=2" class="badge" style="text-decoration:none; {% if tier_filter == '2' %}background:#d29922{% else %}background:#30363d{% endif %}">Tier 2</a>
        <a href="/scanner?tier=3" class="badge" style="text-decoration:none; {% if tier_filter == '3' %}background:#238636{% else %}background:#30363d{% endif %}">Tier 3</a>
    </div>

    <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
        <thead>
            <tr style="border-bottom:1px solid #30363d; color:#8b949e;">
                <th style="text-align:left; padding:0.4rem 0.6rem;">Ticker</th>
                <th style="text-align:right; padding:0.4rem 0.6rem;">Score</th>
                <th style="text-align:left; padding:0.4rem 0.6rem;">Narrative</th>
                <th style="text-align:center; padding:0.4rem 0.6rem;">Depth</th>
                <th style="text-align:right; padding:0.4rem 0.6rem;">MCap</th>
                <th style="text-align:right; padding:0.4rem 0.6rem;">Liq</th>
                <th style="text-align:left; padding:0.4rem 0.6rem;">Platform</th>
                <th style="text-align:left; padding:0.4rem 0.6rem;">Source</th>
                <th style="text-align:left; padding:0.4rem 0.6rem;">Discovered</th>
            </tr>
        </thead>
        <tbody>
            {% for c in candidates %}
            <tr style="border-bottom:1px solid #21262d;">
                <td style="padding:0.4rem 0.6rem; font-weight:600;">
                    <a href="https://dexscreener.com/{{ c.chain }}/{{ c.ca }}" target="_blank" style="color:#58a6ff; text-decoration:none;">
                        ${{ c.ticker }}
                    </a>
                </td>
                <td style="text-align:right; padding:0.4rem 0.6rem;">
                    <span class="score {% if c.tier == 1 %}score-high{% elif c.tier == 2 %}score-mid{% endif %}">
                        {{ "%.0f"|format(c.composite_score) }}
                    </span>
                </td>
                <td style="padding:0.4rem 0.6rem; font-size:0.8rem;">
                    {% set themes = c.matched_themes | default('[]') %}
                    {% if themes and themes != '[]' %}
                        {{ themes[:50] }}
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td style="text-align:center; padding:0.4rem 0.6rem;">{{ c.narrative_depth }}</td>
                <td style="text-align:right; padding:0.4rem 0.6rem;">
                    {% if c.mcap %}
                        {% if c.mcap >= 1000000 %}${{ "%.1f"|format(c.mcap / 1000000) }}M
                        {% elif c.mcap >= 1000 %}${{ "%.1f"|format(c.mcap / 1000) }}K
                        {% else %}${{ "%.0f"|format(c.mcap) }}{% endif %}
                    {% else %}N/A{% endif %}
                </td>
                <td style="text-align:right; padding:0.4rem 0.6rem;">
                    {% if c.liquidity_usd %}
                        {% if c.liquidity_usd >= 1000000 %}${{ "%.1f"|format(c.liquidity_usd / 1000000) }}M
                        {% elif c.liquidity_usd >= 1000 %}${{ "%.1f"|format(c.liquidity_usd / 1000) }}K
                        {% else %}${{ "%.0f"|format(c.liquidity_usd) }}{% endif %}
                    {% else %}N/A{% endif %}
                </td>
                <td style="padding:0.4rem 0.6rem;">
                    <span class="ticker-tag">{{ c.platform }}</span>
                </td>
                <td style="padding:0.4rem 0.6rem; color:#8b949e;">{{ c.discovery_source }}</td>
                <td style="padding:0.4rem 0.6rem; color:#8b949e; font-size:0.8rem;">
                    {{ c.discovered_at.strftime('%m/%d %H:%M') if c.discovered_at else '—' }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty">No scanner candidates yet. The scanner discovers tokens automatically when enabled.</p>
    {% endif %}
</div>

{% endblock %}

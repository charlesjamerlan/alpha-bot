{% extends "base.html" %}
{% block title %}Backtest — Alpha Bot{% endblock %}
{% block content %}
<h2>Backtest & Scoring Weights</h2>

{% if error %}
<div class="section-card" style="border-color: #f85149;">
    <p style="color: #f85149;">Error: {{ error }}</p>
</div>
{% endif %}

<!-- Run Backtest Form -->
<div class="section-card">
    <h3>Run Backtest</h3>
    <form method="post" action="/backtest" class="research-form">
        <input type="number" name="days" value="30" min="1" max="365"
               style="background:#0d1117;border:1px solid #30363d;color:#c9d1d9;padding:0.6rem;border-radius:6px;width:100px;">
        <span style="color:#8b949e;align-self:center;">days lookback</span>
        <button type="submit">Run Backtest</button>
    </form>
</div>

<!-- Current Weights -->
<div class="section-card">
    <h3>Current Scoring Weights</h3>
    {% if active_weights %}
    <p style="color:#8b949e;font-size:0.85rem;">
        Version {{ active_weights.version }} ({{ active_weights.source }})
        — {{ active_weights.created_at.strftime('%Y-%m-%d %H:%M UTC') }}
    </p>
    <div class="stats-grid" style="margin-top:0.8rem;">
        {% for label, val in [
            ('Narrative', active_weights.w_narrative),
            ('Profile', active_weights.w_profile),
            ('Platform', active_weights.w_platform),
            ('Market', active_weights.w_market),
            ('Depth', active_weights.w_depth),
            ('Source', active_weights.w_source),
        ] %}
        <div class="stat-box">
            <div class="value">{{ "%.0f"|format(val * 100) }}%</div>
            <div class="label">{{ label }}</div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="color:#8b949e;">Using default weights (no DB weights set).</p>
    <div class="stats-grid" style="margin-top:0.8rem;">
        {% for label, val in [('Narrative', 25), ('Profile', 20), ('Platform', 15), ('Market', 15), ('Depth', 15), ('Source', 10)] %}
        <div class="stat-box">
            <div class="value">{{ val }}%</div>
            <div class="label">{{ label }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Past Runs -->
<h3 style="margin-top:1.5rem;">Backtest History</h3>
{% if runs %}
{% for r in runs %}
<div class="section-card">
    <div class="signal-header">
        <span style="color:#58a6ff;font-weight:600;">
            {{ r.run_timestamp.strftime('%Y-%m-%d %H:%M') }} — {{ r.lookback_days }}d lookback
        </span>
        <span style="color:#8b949e;">{{ r.token_count }} tokens</span>
    </div>
    <div class="stats-grid">
        <div class="stat-box">
            <div class="value">{{ r.tier1_count }}</div>
            <div class="label">Tier 1</div>
        </div>
        <div class="stat-box">
            <div class="value">{{ "%.0f"|format(r.tier1_hit_rate_2x * 100) }}%</div>
            <div class="label">T1 2x Rate</div>
        </div>
        <div class="stat-box">
            <div class="value">{{ "%+.0f"|format(r.tier1_avg_roi) }}%</div>
            <div class="label">T1 Avg ROI</div>
        </div>
        <div class="stat-box">
            <div class="value">{{ r.tier2_count }}</div>
            <div class="label">Tier 2</div>
        </div>
        <div class="stat-box">
            <div class="value">{{ "%.0f"|format(r.tier2_hit_rate_2x * 100) }}%</div>
            <div class="label">T2 2x Rate</div>
        </div>
        <div class="stat-box">
            <div class="value">{{ "%+.0f"|format(r.tier2_avg_roi) }}%</div>
            <div class="label">T2 Avg ROI</div>
        </div>
    </div>
    <p style="color:#8b949e;font-size:0.8rem;margin-top:0.5rem;">
        Optimal thresholds: T1={{ "%.0f"|format(r.optimal_tier1_threshold) }},
        T2={{ "%.0f"|format(r.optimal_tier2_threshold) }}
    </p>
</div>
{% endfor %}
{% else %}
<div class="empty">No backtest runs yet. Run one above to see results.</div>
{% endif %}
{% endblock %}

{% extends "base.html" %}
{% block title %}TRENCH EDGE — Command Center{% endblock %}

{% block content %}

{# ── Quick Scan Result (only rendered after POST /scan) ── #}
{% if scan_result %}
<div class="scan-result-card">
    {% set s = scan_result %}
    {% set tier_class = 'tier1' if s.tier == 1 else ('tier2' if s.tier == 2 else 'tier3') %}

    {# ── Header: Tier + Score + Token identity ── #}
    <div class="scan-result-header">
        <span class="scan-tier {{ tier_class }}">TIER {{ s.tier }}</span>
        <span class="scan-score">{{ s.composite|int }}/100</span>
        <span class="scan-ticker">${{ s.symbol }}</span>
        <span class="scan-name">{{ s.name }}</span>
        <button class="copy-ca" onclick="copyCA('{{ s.ca }}')" title="Copy CA">&#x2398;</button>
        <a class="dex-link" href="https://dexscreener.com/{{ s.chain }}/{{ s.ca }}" target="_blank" rel="noopener" title="View on DexScreener">&#x2197;</a>
    </div>

    {# ── Key stats row ── #}
    <div class="scan-stats-row">
        <div class="stat-box"><div class="value">{{ s.price_str }}</div><div class="label">Price</div></div>
        <div class="stat-box"><div class="value">{{ s.mcap_str }}</div><div class="label">MCap</div></div>
        <div class="stat-box"><div class="value">{{ s.liq_str }}</div><div class="label">Liquidity</div></div>
        <div class="stat-box"><div class="value">{{ s.vol_str }}</div><div class="label">Vol 24h</div></div>
        <div class="stat-box"><div class="value">{{ s.age_str }}</div><div class="label">Age</div></div>
        <div class="stat-box"><div class="value">{{ s.liq_mcap_pct }}</div><div class="label">Liq/MCap</div></div>
    </div>

    {# ── Price changes ── #}
    <div class="scan-changes-row">
        {% for label, val in [('5m', s.change_5m), ('1h', s.change_1h), ('6h', s.change_6h), ('24h', s.change_24h)] %}
        <div class="change-cell">
            <span class="change-label">{{ label }}</span>
            {% if val is not none %}
            <span class="change-val {% if val > 0 %}pnl-up{% elif val < 0 %}pnl-down{% endif %}">{{ '%+.1f' | format(val) }}%</span>
            {% else %}
            <span class="change-val">&mdash;</span>
            {% endif %}
        </div>
        {% endfor %}
        <div class="change-cell">
            <span class="change-label">B/S 24h</span>
            {% if s.buys_24h is not none and s.sells_24h is not none %}
            <span class="change-val">{{ s.buys_24h }}/{{ s.sells_24h }}</span>
            {% else %}
            <span class="change-val">&mdash;</span>
            {% endif %}
        </div>
        <div class="change-cell">
            <span class="change-label">B/S 1h</span>
            {% if s.buys_1h is not none and s.sells_1h is not none %}
            <span class="change-val">{{ s.buys_1h }}/{{ s.sells_1h }}</span>
            {% else %}
            <span class="change-val">&mdash;</span>
            {% endif %}
        </div>
        <div class="change-cell">
            <span class="change-label">Ratio</span>
            <span class="change-val">{{ s.buy_sell_ratio }}</span>
        </div>
    </div>

    {# ── Scoring breakdown (collapsible detail) ── #}
    <details class="scan-scoring-details">
        <summary>Scoring Breakdown</summary>
        <div class="scan-breakdown">
            <div class="scan-row"><span class="scan-label">Chain</span><span>{{ s.chain }}{% if s.dex %} ({{ s.dex }}){% endif %}</span></div>
            <div class="scan-row"><span class="scan-label">Platform</span><span>{{ s.platform }}</span></div>
            <div class="scan-row"><span class="scan-label">Narrative</span><span>{{ s.narrative_score|int }}/100 — {{ s.themes_str }}</span></div>
            <div class="scan-row"><span class="scan-label">Depth</span><span>{{ s.depth }}/100 ({{ s.depth // 25 }} layers)</span></div>
            <div class="scan-row"><span class="scan-label">Profile</span><span>{{ s.profile_score|int }}/100</span></div>
            <div class="scan-row"><span class="scan-label">Platform %ile</span><span>{{ s.platform_str }}</span></div>
            <div class="scan-row"><span class="scan-label">Market</span><span>{{ s.market_score|int }}/100</span></div>
        </div>
    </details>

    {% if s.entities %}
    <div class="scan-entities">
        <span class="scan-label">Notable Holders</span>
        <div class="scan-entity-chips">
            {% for e in s.entities %}
            <span class="entity-chip entity-{{ e.entity_type }}">{{ e.entity_name }}{% if e.pct_supply %} ({{ e.pct_supply }}%){% endif %}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="scan-ca"><code>{{ s.ca }}</code></div>
</div>
{% endif %}

{% if scan_error %}
<div class="scan-result-card scan-error">
    <span class="scan-label">Scan failed:</span> {{ scan_error }}
</div>
{% endif %}

{# ── Conviction Alerts ── #}
<section class="panel-section conviction-section">
    <h3>Conviction Alerts</h3>
    {% if conviction_alerts %}
    <div class="conviction-grid">
        {% for a in conviction_alerts %}
        <div class="conviction-card">
            <div class="conviction-header">
                <span class="conviction-ticker">${{ a.ticker or '?' }}</span>
                <span class="conviction-score {% if a.conviction_score >= 80 %}score-high{% else %}score-mid{% endif %}">{{ a.conviction_score|int }}/100</span>
                <button class="copy-ca" onclick="copyCA('{{ a.ca }}')" title="Copy CA">&#x2398;</button>
                <a class="dex-link" href="https://dexscreener.com/{{ a.chain }}/{{ a.ca }}" target="_blank" rel="noopener" title="View on DexScreener">&#x2197;</a>
                <button class="scan-btn-sm" onclick="scanCA('{{ a.ca }}')" title="Scan this token">&#x2316;</button>
            </div>
            <div class="conviction-meta">
                {{ a.distinct_sources }} source{{ 's' if a.distinct_sources != 1 else '' }}
                &middot; {{ a.alerted_at | timeago }}
            </div>
            {% if a._sources_list %}
            <div class="conviction-sources">
                {% for src in a._sources_list %}
                <span class="source-badge">{{ src }}</span>
                {% endfor %}
            </div>
            {% endif %}
            <div class="conviction-ca"><code>{{ a.ca[:8] }}...{{ a.ca[-4:] }}</code></div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-small">No conviction alerts in the last 24 hours</div>
    {% endif %}
</section>

{# ── Entity Intel ── #}
{% if active_entities %}
<section class="panel-section entity-section">
    <h3>Entity Intel</h3>
    <div class="entity-grid">
        {% for e in active_entities %}
        <div class="entity-card entity-border-{{ e.entity_type }}">
            <div class="entity-card-header">
                <span class="entity-badge entity-{{ e.entity_type }}">{{ e.entity_type|upper }}</span>
                <span class="entity-name">{{ e.entity_name }}</span>
            </div>
            {% if e.organization %}
            <div class="entity-org">{{ e.organization }}</div>
            {% endif %}
            <div class="entity-meta">
                Q: {{ e.quality_score|int }}
                &middot; ${{ e.last_buy_ticker }}
                &middot; {{ e.last_buy_at | timeago }}
            </div>
            {% if e.ens_name %}
            <div class="entity-ens">{{ e.ens_name }}</div>
            {% endif %}
            <div class="entity-addr">
                <code>{{ e.address[:8] }}...{{ e.address[-4:] }}</code>
                <button class="copy-ca-sm" onclick="copyCA('{{ e.address }}')" title="Copy address">&#x2398;</button>
                <a class="dex-link-sm" href="https://basescan.org/address/{{ e.address }}" target="_blank" rel="noopener" title="BaseScan">&#x2197;</a>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

{# ── X/Twitter Intel ── #}
{% if x_signals %}
<section class="panel-section x-section">
    <h3>X / Twitter Intel <span class="x-count">({{ x_signals|length }})</span></h3>
    <div class="x-signal-grid">
        {% for x in x_signals %}
        <div class="x-card">
            <div class="x-card-top">
                <span class="x-author">@{{ x.author }}</span>
                <span class="x-followers">{{ x.followers_str }}</span>
                <span class="x-type x-type-{{ x.signal_type }}">{{ x.signal_type }}</span>
                <span class="x-time">{{ x.tweeted_at | timeago }}</span>
            </div>
            {% if x.cashtags %}
            <div class="x-cashtags">
                {% for tag in x.cashtags %}
                <span class="x-cashtag">{{ tag }}</span>
                {% endfor %}
            </div>
            {% endif %}
            {% if x.text %}
            <div class="x-text">{{ x.text }}</div>
            {% endif %}
            <div class="x-card-bottom">
                {% if x.ca %}
                <code class="x-ca">{{ x.ca[:8] }}...{{ x.ca[-4:] }}</code>
                <button class="copy-ca-sm" onclick="copyCA('{{ x.ca }}')" title="Copy CA">&#x2398;</button>
                <a class="dex-link-sm" href="https://dexscreener.com/{{ x.chain }}/{{ x.ca }}" target="_blank" rel="noopener" title="DexScreener">&#x2197;</a>
                <button class="scan-btn-sm" onclick="scanCA('{{ x.ca }}')" title="Scan">&#x2316;</button>
                {% endif %}
                {% if x.tweet_url %}
                <a class="x-tweet-link" href="{{ x.tweet_url }}" target="_blank" rel="noopener" title="View tweet">&#x1D54F;</a>
                {% endif %}
                <span class="x-chain-badge x-chain-{{ x.chain }}">{{ x.chain }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

{# ── Live Feed + Smart Wallets (2/3 + 1/3 layout) ── #}
<div class="feed-wallet-grid">

{# ── Live Signal Feed (2/3 width, auto-refreshes via HTMX) ── #}
<section class="panel-section feed-section">
    <div class="feed-head">
        <h3>Live Feed</h3>
        <div class="feed-filters">
            <div class="filter-group" data-filter="source">
                <button class="filter-chip active" data-value="all">All</button>
                <button class="filter-chip" data-value="TG">TG</button>
                <button class="filter-chip" data-value="SCAN">Scan</button>
                <button class="filter-chip" data-value="WALLET">Wallet</button>
                <button class="filter-chip" data-value="CONV">Conv</button>
                <button class="filter-chip" data-value="X">X</button>
            </div>
            <span class="filter-sep"></span>
            <div class="filter-group" data-filter="signal">
                <button class="filter-chip active" data-value="all">All</button>
                <button class="filter-chip" data-value="BUY">BUY only</button>
            </div>
        </div>
    </div>
    <div id="feed-container"
         hx-get="/partials/feed"
         hx-trigger="every 15s"
         hx-swap="innerHTML"
    >
        {% include "_feed_partial.html" %}
    </div>
</section>

{# ── Smart Wallets (1/3 sidebar) ── #}
{% if smart_wallets %}
<section class="panel-section wallet-section">
    <h3>Smart Wallets <span class="wallet-count">({{ smart_wallets|length }})</span></h3>
    <div class="wallet-table-wrap">
        <table class="wallet-table">
            <thead>
                <tr>
                    <th>Wallet</th>
                    <th>Q</th>
                    <th>W</th>
                </tr>
            </thead>
            <tbody>
                {% for w in smart_wallets %}
                <tr class="wallet-row">
                    <td class="wallet-info-cell">
                        <div class="wallet-addr-line">
                            <code>{{ w.address[:6] }}...{{ w.address[-4:] }}</code>
                            <button class="copy-ca-sm" onclick="copyCA('{{ w.address }}')" title="Copy">&#x2398;</button>
                            <a href="https://basescan.org/address/{{ w.address }}" target="_blank" rel="noopener" title="BaseScan" class="wallet-ext-link">&#x2197;</a>
                        </div>
                        {% if w.entity_name %}
                        <div class="wallet-entity-line">
                            <span class="entity-badge entity-{{ w.entity_type }}">{{ w.entity_type|upper }}</span>
                            <span class="wallet-entity-name">{{ w.entity_name }}</span>
                        </div>
                        {% elif w.label %}
                        <div class="wallet-entity-line">
                            <span class="wallet-label-text">{{ w.label[:30] }}</span>
                        </div>
                        {% endif %}
                        {% if w.ens_name %}
                        <div class="wallet-ens">{{ w.ens_name }}</div>
                        {% endif %}
                    </td>
                    <td class="wallet-q {% if w.quality_score >= 80 %}q-high{% elif w.quality_score >= 50 %}q-mid{% else %}q-low{% endif %}">
                        {{ w.quality_score|int }}
                    </td>
                    <td class="wallet-wins">{{ w.total_wins }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

</div>{# /feed-wallet-grid #}

<script>
function copyCA(ca) {
    navigator.clipboard.writeText(ca).then(function() {
        var btns = document.querySelectorAll('.copy-ca, .copy-ca-sm');
        btns.forEach(function(b) {
            if (b.getAttribute('onclick').indexOf(ca) !== -1) {
                b.textContent = '\u2713';
                setTimeout(function() { b.innerHTML = '\u2398'; }, 1200);
            }
        });
    });
}
function scanCA(ca) {
    var form = document.querySelector('.scan-form');
    var input = form.querySelector('input[name="ca"]');
    input.value = ca;
    form.submit();
}

// ── Feed filters (global so they persist across HTMX swaps) ──
var _activeSource = 'all';
var _activeSignal = 'all';

function applyFeedFilters() {
    var rows = document.querySelectorAll('.feed-row-rich');
    var visible = 0;
    rows.forEach(function(row) {
        var src = row.getAttribute('data-source');
        var sig = row.getAttribute('data-signal');
        var showSrc = _activeSource === 'all' || src === _activeSource;
        var showSig = _activeSignal === 'all' || sig === _activeSignal;
        if (showSrc && showSig) {
            row.style.display = '';
            visible++;
        } else {
            row.style.display = 'none';
        }
    });
    var empty = document.getElementById('feed-empty');
    if (empty) empty.style.display = visible === 0 ? '' : 'none';
}

// Re-apply filters after every HTMX swap
document.getElementById('feed-container').addEventListener('htmx:afterSwap', function() {
    applyFeedFilters();
});

// Wire filter chip clicks
document.querySelectorAll('.filter-group').forEach(function(group) {
    var filterType = group.getAttribute('data-filter');
    group.querySelectorAll('.filter-chip').forEach(function(chip) {
        chip.addEventListener('click', function() {
            group.querySelectorAll('.filter-chip').forEach(function(c) { c.classList.remove('active'); });
            chip.classList.add('active');
            if (filterType === 'source') _activeSource = chip.getAttribute('data-value');
            else _activeSignal = chip.getAttribute('data-value');
            applyFeedFilters();
        });
    });
});
</script>

{% endblock %}

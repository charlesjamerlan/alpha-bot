{% extends "base.html" %}
{% block title %}TRENCH EDGE — Command Center{% endblock %}

{% block content %}

{# ── Quick Scan Result (only rendered after POST /scan) ── #}
{% if scan_result %}
<div class="scan-result-card">
    {% set s = scan_result %}
    {% set tier_class = 'tier1' if s.tier == 1 else ('tier2' if s.tier == 2 else 'tier3') %}

    {# ── Header: Tier + Score + Token identity ── #}
    <div class="scan-result-header">
        <span class="scan-tier {{ tier_class }}">TIER {{ s.tier }}</span>
        <span class="scan-score">{{ s.composite|int }}/100</span>
        <span class="scan-ticker">${{ s.symbol }}</span>
        <span class="scan-name">{{ s.name }}</span>
        <button class="copy-ca" onclick="copyCA('{{ s.ca }}')" title="Copy CA">&#x2398;</button>
        <a class="dex-link" href="https://dexscreener.com/{{ s.chain }}/{{ s.ca }}" target="_blank" rel="noopener" title="View on DexScreener">&#x2197;</a>
    </div>

    {# ── Key stats row ── #}
    <div class="scan-stats-row">
        <div class="stat-box"><div class="value">{{ s.price_str }}</div><div class="label">Price</div></div>
        <div class="stat-box"><div class="value">{{ s.mcap_str }}</div><div class="label">MCap</div></div>
        <div class="stat-box"><div class="value">{{ s.liq_str }}</div><div class="label">Liquidity</div></div>
        <div class="stat-box"><div class="value">{{ s.vol_str }}</div><div class="label">Vol 24h</div></div>
        <div class="stat-box"><div class="value">{{ s.age_str }}</div><div class="label">Age</div></div>
        <div class="stat-box"><div class="value">{{ s.liq_mcap_pct }}</div><div class="label">Liq/MCap</div></div>
    </div>

    {# ── Price changes ── #}
    <div class="scan-changes-row">
        {% for label, val in [('5m', s.change_5m), ('1h', s.change_1h), ('6h', s.change_6h), ('24h', s.change_24h)] %}
        <div class="change-cell">
            <span class="change-label">{{ label }}</span>
            {% if val is not none %}
            <span class="change-val {% if val > 0 %}pnl-up{% elif val < 0 %}pnl-down{% endif %}">{{ '%+.1f' | format(val) }}%</span>
            {% else %}
            <span class="change-val">&mdash;</span>
            {% endif %}
        </div>
        {% endfor %}
        <div class="change-cell">
            <span class="change-label">B/S 24h</span>
            {% if s.buys_24h is not none and s.sells_24h is not none %}
            <span class="change-val">{{ s.buys_24h }}/{{ s.sells_24h }}</span>
            {% else %}
            <span class="change-val">&mdash;</span>
            {% endif %}
        </div>
        <div class="change-cell">
            <span class="change-label">B/S 1h</span>
            {% if s.buys_1h is not none and s.sells_1h is not none %}
            <span class="change-val">{{ s.buys_1h }}/{{ s.sells_1h }}</span>
            {% else %}
            <span class="change-val">&mdash;</span>
            {% endif %}
        </div>
        <div class="change-cell">
            <span class="change-label">Ratio</span>
            <span class="change-val">{{ s.buy_sell_ratio }}</span>
        </div>
    </div>

    {# ── Scoring breakdown (collapsible detail) ── #}
    <details class="scan-scoring-details">
        <summary>Scoring Breakdown</summary>
        <div class="scan-breakdown">
            <div class="scan-row"><span class="scan-label">Chain</span><span>{{ s.chain }}{% if s.dex %} ({{ s.dex }}){% endif %}</span></div>
            <div class="scan-row"><span class="scan-label">Platform</span><span>{{ s.platform }}</span></div>
            <div class="scan-row"><span class="scan-label">Narrative</span><span>{{ s.narrative_score|int }}/100 — {{ s.themes_str }}</span></div>
            <div class="scan-row"><span class="scan-label">Depth</span><span>{{ s.depth }}/100 ({{ s.depth // 25 }} layers)</span></div>
            <div class="scan-row"><span class="scan-label">Profile</span><span>{{ s.profile_score|int }}/100</span></div>
            <div class="scan-row"><span class="scan-label">Platform %ile</span><span>{{ s.platform_str }}</span></div>
            <div class="scan-row"><span class="scan-label">Market</span><span>{{ s.market_score|int }}/100</span></div>
        </div>
    </details>

    <div class="scan-ca"><code>{{ s.ca }}</code></div>
</div>
{% endif %}

{% if scan_error %}
<div class="scan-result-card scan-error">
    <span class="scan-label">Scan failed:</span> {{ scan_error }}
</div>
{% endif %}

{# ── Conviction Alerts ── #}
<section class="panel-section conviction-section">
    <h3>Conviction Alerts</h3>
    {% if conviction_alerts %}
    <div class="conviction-grid">
        {% for a in conviction_alerts %}
        <div class="conviction-card">
            <div class="conviction-header">
                <span class="conviction-ticker">${{ a.ticker or '?' }}</span>
                <span class="conviction-score {% if a.conviction_score >= 80 %}score-high{% else %}score-mid{% endif %}">{{ a.conviction_score|int }}/100</span>
                <button class="copy-ca" onclick="copyCA('{{ a.ca }}')" title="Copy CA">&#x2398;</button>
                <a class="dex-link" href="https://dexscreener.com/{{ a.chain }}/{{ a.ca }}" target="_blank" rel="noopener" title="View on DexScreener">&#x2197;</a>
                <button class="scan-btn-sm" onclick="scanCA('{{ a.ca }}')" title="Scan this token">&#x2316;</button>
            </div>
            <div class="conviction-meta">
                {{ a.distinct_sources }} source{{ 's' if a.distinct_sources != 1 else '' }}
                &middot; {{ a.alerted_at | timeago }}
            </div>
            {% if a._sources_list %}
            <div class="conviction-sources">
                {% for src in a._sources_list %}
                <span class="source-badge">{{ src }}</span>
                {% endfor %}
            </div>
            {% endif %}
            <div class="conviction-ca"><code>{{ a.ca[:8] }}...{{ a.ca[-4:] }}</code></div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-small">No conviction alerts in the last 24 hours</div>
    {% endif %}
</section>

{# ── Live Signal Feed (full width) ── #}
<section class="panel-section feed-section">
    <div class="feed-head">
        <h3>Live Feed</h3>
        <div class="feed-filters">
            <div class="filter-group" data-filter="source">
                <button class="filter-chip active" data-value="all">All</button>
                <button class="filter-chip" data-value="TG">TG</button>
                <button class="filter-chip" data-value="SCAN">Scan</button>
                <button class="filter-chip" data-value="WALLET">Wallet</button>
                <button class="filter-chip" data-value="CONV">Conv</button>
                <button class="filter-chip" data-value="X">X</button>
            </div>
            <span class="filter-sep"></span>
            <div class="filter-group" data-filter="signal">
                <button class="filter-chip active" data-value="all">All</button>
                <button class="filter-chip" data-value="BUY">BUY only</button>
            </div>
        </div>
    </div>
    {% if feed %}
    <div class="feed-table" id="feed-table">
        <div class="feed-header-row">
            <span>Source</span>
            <span>Token</span>
            <span>Score</span>
            <span>MCap</span>
            <span>Change</span>
            <span>Signal</span>
            <span>When</span>
        </div>
        {% for item in feed %}
        <div class="feed-row-rich {% if item.rec == 'BUY' %}feed-rec-buy{% endif %}" data-source="{{ item.source_type }}" data-signal="{{ item.rec or '' }}">
            <span class="feed-badge feed-badge-{{ item.source_type|lower }}">{{ item.source_type }}</span>
            <span class="feed-token">
                <span class="feed-ticker">${{ item.ticker or '?' }}</span>
                {% if item.platform %}<span class="feed-plat">{{ item.platform }}</span>{% endif %}
                <button class="copy-ca-sm" onclick="copyCA('{{ item.ca }}')" title="Copy CA">&#x2398;</button>
                <a class="dex-link-sm" href="https://dexscreener.com/{{ item.chain or 'base' }}/{{ item.ca }}" target="_blank" rel="noopener" title="DexScreener">&#x2197;</a>
                <button class="scan-btn-sm" onclick="scanCA('{{ item.ca }}')" title="Scan">&#x2316;</button>
            </span>
            <span class="feed-score-cell">
                {% if item.score is not none %}
                <span class="feed-score-val {% if item.score >= 80 %}fs-high{% elif item.score >= 60 %}fs-mid{% else %}fs-low{% endif %}">{{ item.score|int }}</span>
                {% else %}
                <span class="feed-score-val fs-na">&mdash;</span>
                {% endif %}
            </span>
            <span class="feed-mcap mono">{{ item.mcap_str or '&mdash;' }}</span>
            <span class="feed-change mono {% if item.change and item.change > 0 %}pnl-up{% elif item.change and item.change < 0 %}pnl-down{% endif %}">
                {% if item.change is not none %}{{ '%+.0f' | format(item.change) }}%{% else %}&mdash;{% endif %}
            </span>
            <span class="feed-signal">{{ item.signal_str or '' }}</span>
            <span class="feed-time">{{ item.timestamp | timeago }}</span>
        </div>
        {% endfor %}
    </div>
    <div class="empty-small" id="feed-empty" style="display:none">No signals match filters</div>
    {% else %}
    <div class="empty-small">No recent signals</div>
    {% endif %}
</section>

<script>
function copyCA(ca) {
    navigator.clipboard.writeText(ca).then(function() {
        var btns = document.querySelectorAll('.copy-ca, .copy-ca-sm');
        btns.forEach(function(b) {
            if (b.getAttribute('onclick').indexOf(ca) !== -1) {
                b.textContent = '\u2713';
                setTimeout(function() { b.innerHTML = '\u2398'; }, 1200);
            }
        });
    });
}
function scanCA(ca) {
    var form = document.querySelector('.scan-form');
    var input = form.querySelector('input[name="ca"]');
    input.value = ca;
    form.submit();
}

// ── Feed filters ──
(function() {
    var activeSource = 'all';
    var activeSignal = 'all';

    function applyFilters() {
        var rows = document.querySelectorAll('.feed-row-rich');
        var visible = 0;
        rows.forEach(function(row) {
            var src = row.getAttribute('data-source');
            var sig = row.getAttribute('data-signal');
            var showSrc = activeSource === 'all' || src === activeSource;
            var showSig = activeSignal === 'all' || sig === activeSignal;
            if (showSrc && showSig) {
                row.style.display = '';
                visible++;
            } else {
                row.style.display = 'none';
            }
        });
        var empty = document.getElementById('feed-empty');
        if (empty) empty.style.display = visible === 0 ? '' : 'none';
    }

    document.querySelectorAll('.filter-group').forEach(function(group) {
        var filterType = group.getAttribute('data-filter');
        group.querySelectorAll('.filter-chip').forEach(function(chip) {
            chip.addEventListener('click', function() {
                group.querySelectorAll('.filter-chip').forEach(function(c) { c.classList.remove('active'); });
                chip.classList.add('active');
                if (filterType === 'source') activeSource = chip.getAttribute('data-value');
                else activeSignal = chip.getAttribute('data-value');
                applyFilters();
            });
        });
    });
})();
</script>

{% endblock %}
